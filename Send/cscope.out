cscope 15 $HOME/work/bhc_work/CustomProtocolDemo/Send               0000010254
	@main.cpp

1 
	~<QtGui/QAµliˇti⁄
>

2 
	~"maöwödow.h
"

4 
	$maö
(
¨gc
, *
¨gv
[])

6 
QAµliˇti⁄
 
	`a
(
¨gc
, 
¨gv
);

7 
MaöWödow
 
w
;

8 
w
.
	`show
();

10  
a
.
	`exec
();

11 
	}
}

	@mainwindow.cpp

1 
	~"maöwödow.h
"

2 
	~"ui_maöwödow.h
"

3 
	~<zçm™agî.h
>

4 
	~<zç¥Ÿocﬁ.h
>

5 
	~<QHo°Addªss
>

6 
	~<QFûe
>

7 
	gMaöWödow
::
	$MaöWödow
(
QWidgë
 *
∑ª¡
) :

8 
	`QMaöWödow
(
∑ª¡
),

9 
	`ui
(
√w
 
Ui
::
MaöWödow
)

11 
ui
->
	`£tupUi
(
this
);

12 
zçm
 = 
√w
 
	`ZTPM™agî
(1235,
	`QHo°Addªss
("224.124.0.1"));

13 
	`c⁄√˘
(
zçm
,
	`SIGNAL
(
	`ªadyRód
()),
this
,
	`SLOT
(
	`fun
()));

14 
	}
}

15 
	gMaöWödow
::
	$fun
()

17 
ZTP¥Ÿocﬁ
 
zçp
;

18 
zçm
->
	`gëO√Zç
(
zçp
);

20 
QLi°
<
QSåög
> 
∑øLi°
 = 
zçp
.
	`∑øs
();

21 
i
 = 0;i< 
∑øLi°
.
	`Àngth
();i++)

23 
QSåög
 
ãxt
 = "\n"+QSåög::
	`numbî
(
i
)+"---"+
∑øLi°
[i]+" : "+
zçp
.
	`gëP¨a
(paraList[i]);

24 
	`qDebug
()<<
ãxt
;

25 
ui
->
ãxtBrow£r
->
	`ãxtCurs‹
().
	`ö£πText
(
ãxt
);

27 
	}
}

29 
	gMaöWödow
::~
	$MaöWödow
()

31 
dñëe
 
zçm
;

32 
dñëe
 
ui
;

33 
	}
}

35 
	gMaöWödow
::
	$⁄_pushBuâ⁄_˛icked
()

38 
ZTP¥Ÿocﬁ
 
zçp
;

39 
zçp
.
	`addP¨a
("type","hellow");

40 
zçm
->
	`SídO√Zç
(
zçp
,
	`QHo°Addªss
("224.124.0.1"),1235);

42 
QUdpSockë
 
udp
;

43 
udp
.
	`böd
(
QHo°Addªss
::
Any
);

44 
QFûe
 
	`fûe
("test.png");

45 
fûe
.
	`›í
(
QFûe
::
RódO∆y
);

48 
	`qDebug
()<<"ud∞£ndÜí :"<<
udp
.
	`wrôeD©agøm
(
fûe
.
	`ªadAŒ
().
	`d©a
(),65508,
	`QHo°Addªss
("224.124.0.1"),3333);

49 
fûe
.
	`˛o£
();

58 
	}
}

60 
	gMaöWödow
::
	$⁄_pushBuâ⁄_2_˛icked
()

62 
ui
->
ãxtBrow£r
->
	`˛ór
();

63 
	}
}

	@mainwindow.h

1 #i‚de‡
MAINWINDOW_H


2 
	#MAINWINDOW_H


	)

4 
	~<QMaöWödow
>

5 
	~<zçm™agî.h
>

6 
«me•a˚
 
	gUi
 {

7 
˛ass
 
	gMaöWödow
;

10 ˛as†
	cMaöWödow
 : 
public
 
QMaöWödow


12 
Q_OBJECT


13 
ZTPM™agî
* 
zçm
;

14 
	mpublic
:

15 
ex∂icô
 
MaöWödow
(
QWidgë
 *
∑ª¡
 = 0);

16 ~
MaöWödow
();

18 
¥iv©e
 
	m¶Ÿs
:

19 
⁄_pushBuâ⁄_˛icked
();

21 
⁄_pushBuâ⁄_2_˛icked
();

22 
fun
();

24 
	m¥iv©e
:

25 
Ui
::
MaöWödow
 *
ui
;

	@ztpmanager.cpp

1 
	~"zçm™agî.h
"

3 
	gZTPM™agî
::
	$ZTPM™agî
(
QHo°Addªss
 
ho°
,
quöt16
 
p‹t
,

4 
QHo°Addªss
 
groupAddªss
, 
QObje˘
 *
∑ª¡
):

5 
	$QObje˘
(
∑ª¡
)

8 
_Sockëli°íî
.
	`böd
(
ho°
,
p‹t
,
QUdpSockë
::
Sh¨eAddªss
);

9 if(
groupAddªss
.
	`toIPv4Addªss
()>0xe0000000 && groupAddress.toIPv4Address()<0xf0000000)

11 
_Sockëli°íî
.
	`joöMu…iˇ°Group
(
groupAddªss
);

14 
	`c⁄√˘
(&
_Sockëli°íî
,
	`SIGNAL
(
	`ªadyRód
()),
this
,SIGNAL(readyRead()));

15 
MTU
 = 65507;

16 
	}
}

17 
	gZTPM™agî
::
	$ZTPM™agî
(
quöt16
 
p‹t
,

18 
QHo°Addªss
 
groupAddªss
, 
QObje˘
 *
∑ª¡
):

19 
	$QObje˘
(
∑ª¡
)

21 
_Sockëli°íî
.
	`böd
(
QHo°Addªss
::
Any
,
p‹t
,
QUdpSockë
::
Sh¨eAddªss
);

22 if(
groupAddªss
.
	`toIPv4Addªss
()>0xe0000000 && groupAddress.toIPv4Address()<0xf0000000)

24 
_Sockëli°íî
.
	`joöMu…iˇ°Group
(
groupAddªss
);

27 
	`c⁄√˘
(&
_Sockëli°íî
,
	`SIGNAL
(
	`ªadyRód
()),
this
,SIGNAL(readyRead()));

28 
	}
}

29 
	gZTPM™agî
::
Resu…Sèã
 
ZTPM™agî
::
	$gëO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
)

31 
QHo°Addªss
 
ªmŸeHo°
;

32 
quöt16
 
ªmŸeP‹t
;

33 
QByãAºay
 
	`ªcvBuff
(
_Sockëli°íî
.
	`≥ndögD©agømSize
(),'\0');

34 
qöt64
 
≥ndögLí
 = 
_Sockëli°íî
.
	`ªadD©agøm
(
ªcvBuff
.
	`d©a
(),ªcvBuff.
	`Àngth
(),&
ªmŸeHo°
,&
ªmŸeP‹t
);

35 
qöt64
 
Àn
;

36 
	`mem˝y
(&
Àn
,
ªcvBuff
.
	`d©a
()+6,8);

37 if(
≥ndögLí
!=
Àn
)

39 
	`qDebug
("recv ZTP dataÉrror: has data %lld bytesándáctuallyÑecv %lld bytes!!\n",

40 
Àn
,
≥ndögLí
);

41  
FAILED
;

43 
zç
.
	`˛ór
();

44 
zç
.
	`lﬂd
(
ªcvBuff
);

45 
zç
.
	`addP¨a
("RemŸeHo°",
ªmŸeHo°
.
	`toSåög
());

46 
zç
.
	`addP¨a
("RemŸeP‹t",
QSåög
::
	`numbî
(
ªmŸeP‹t
));

48  
SUCCESS
;

49 
	}
}

50 
	gZTPM™agî
::
Resu…Sèã
 
ZTPM™agî
::
	$waôO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
,
m£cs
)

53 
QHo°Addªss
 
ªmŸeHo°
;

54 
quöt16
 
ªmŸeP‹t
;

55 if(!
_Sockëli°íî
.
	`waôF‹RódyRód
(
m£cs
))

57 if(
_Sockëli°íî
.
	`îr‹
(Ë=
QUdpSockë
::
SockëTimeoutEº‹
)

58  
TIMEOUT
;

61 
	`qDebug
("SocketÉrror!!\n");

62  
FAILED
;

65 
QByãAºay
 
	`ªcvBuff
(
_Sockëli°íî
.
	`≥ndögD©agømSize
(),'\0');

66 
qöt64
 
≥ndögLí
 = 
_Sockëli°íî
.
	`ªadD©agøm
(
ªcvBuff
.
	`d©a
(),ªcvBuff.
	`Àngth
(),&
ªmŸeHo°
,&
ªmŸeP‹t
);

67 
qöt64
 
Àn
;

68 
	`mem˝y
(&
Àn
,
ªcvBuff
.
	`d©a
()+6,8);

69 if(
≥ndögLí
!=
Àn
)

71 
	`qDebug
("recv ZTP dataÉrror: has data %lld bytesándáctuallyÑecv %lld bytes!!\n",

72 
Àn
,
≥ndögLí
);

73  
FAILED
;

75 
zç
.
	`˛ór
();

76 
zç
.
	`lﬂd
(
ªcvBuff
);

77 
zç
.
	`addP¨a
("RemŸeHo°",
ªmŸeHo°
.
	`toSåög
());

78 
zç
.
	`addP¨a
("RemŸeP‹t",
QSåög
::
	`numbî
(
ªmŸeP‹t
));

80  
SUCCESS
;

81 
	}
}

83 
	gZTPM™agî
::
Resu…Sèã
 
ZTPM™agî
::
	$SídO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
,c⁄° 
QHo°Addªss
 &
ho°
,
quöt16
 
p‹t
)

85 
zç
.
	`gí¨©e
();

86 
£ndLí
 = 
_Sockëli°íî
.
	`wrôeD©agøm
(
zç
.
	`gëRwaD©a
(),
ho°
,
p‹t
);

87 if(
£ndLí
 !
zç
.
	`gëRwaD©a
().
	`Àngth
())

89 
	`qDebug
("send ZTP dataÉrror: has data %d bytesándáctually send %d bytes!!\n",

90 
zç
.
	`gëRwaD©a
().
	`Àngth
(),
£ndLí
);

91  
FAILED
;

93  
SUCCESS
;

94 
	}
}

	@ztpmanager.h

1 #i‚de‡
ZTPMANAGER_H


2 
	#ZTPMANAGER_H


	)

3 
	~<QLi°
>

4 
	~<QThªad
>

5 
	~<QHo°Addªss
>

6 
	~<QUdpSockë
>

7 
	~<zç¥Ÿocﬁ.h
>

8 
	~<QD©eTime
>

9 
	~<QByãAºay
>

10 ˛as†
	cZTPM™agî
 : 
public
 
QObje˘


13 
Q_OBJECT


14 
QLi°
<
QByãAºay
> 
zçLi°
;

15 
QUdpSockë
 
	m_Sockëli°íî
;

16 
	mMTU
;

17 ˛as†
	cFøgmít


31 
	mpublic
:

32 
quöt16
 
idítifõr
;

33 
quöt16
 
	mchecksum
;

34 
quöt16
 
	m‰agmít_cou¡
;

35 
quöt16
 
	m‰agmít_off£t
;

36 
quöt32
 
	mÀn
;

37 
QByãAºay
 
	md©a
;

38 
QByãAºay
 
	møwPkg
;

39 
	m¥iv©e
:

41 
quöt16
 
gíî©eChecksum
(){

42 
quöt16
 
sum
 = 0;

43 
	mi
 = 0;i<
	mÀn
+12;i++)

45 if(
	mi
>15 && i <32)

47 
	msum
 +
d©a
[
i
];

49  
	msum
;

51 
	mpublic
:

52 
Føgmít
(){}

53 
ex∂icô
 
Føgmít
(c⁄° 
QByãAºay
& 
byãs
)

55 
øwPkg
 = 
byãs
;

56 
mem˝y
(&
idítifõr
,
byãs
.
d©a
(),16);

57 
mem˝y
(&
checksum
,
byãs
.
d©a
()+16,16);

58 
mem˝y
(&
‰agmít_cou¡
,
byãs
.
d©a
()+32,16);

59 
mem˝y
(&
‰agmít_off£t
,
byãs
.
d©a
()+48,16);

60 
mem˝y
(&
Àn
,
byãs
.
d©a
()+64,32);

61 
	md©a
.
≠≥nd
(
byãs
.
d©a
()+96,
Àn
);

63 
boﬁ
 
isVÆid
(){ 
	mchecksum
 =
gíî©eChecksum
();}

64 
gíî©e
()

66 
	møwPkg
 = 
QByãAºay
(96,0);

67 
mem˝y
(
øwPkg
.
d©a
(),&
idítifõr
,16);

68 
mem˝y
(
øwPkg
.
d©a
()+32,&
‰agmít_cou¡
,16);

69 
mem˝y
(
øwPkg
.
d©a
()+48,&
‰agmít_off£t
,16);

70 
mem˝y
(
øwPkg
.
d©a
()+64,&
Àn
,32);

71 
	møwPkg
.
≠≥nd
(
d©a
);

72 
	mchecksum
 = 
gíî©eChecksum
();

73 
mem˝y
(
øwPkg
.
d©a
(),&
checksum
,16);

75 
boﬁ
 
	m›î©‹
 <(c⁄° 
	mFøgmít
& 
	m‰ag
)

77  
	m‰agmít_off£t
 < 
	m‰ag
.fragment_offset;

81 
	gsig«ls
:

82 
ªadyRód
();

83 
	gpublic
:

84 
	eResu…Sèã


86 
SUCCESS
,

87 
	gTIMEOUT
,

88 
	gFAILED


90 
ex∂icô
 
ZTPM™agî
(
QHo°Addªss
 
ho°
 = QHo°Addªss::
Any
,
quöt16
 
p‹t
 = 0,

91 
QHo°Addªss
 
groupAddªss
 = QHo°Addªss::
Any
, 
QObje˘
 *
∑ª¡
 = 0);

92 
ex∂icô
 
ZTPM™agî
(
quöt16
 
p‹t
,
QHo°Addªss
 
groupAddªss
 = QHo°Addªss::
Any
, 
QObje˘
 *
∑ª¡
 = 0);

93 
Resu…Sèã
 
gëO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
);

94 
Resu…Sèã
 
waôO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
,
m£cs
 = 3000);

95 
Resu…Sèã
 
	$SídO√Zç
(
ZTP¥Ÿocﬁ
& 
zç
,c⁄° 
QHo°Addªss
& 
ho°
,
quöt16
 
p‹t
)

97 
zç
.
	`gí¨©e
();

98 
quöt16
 
idítifõr
 = 
QD©eTime
::
	`cuºítMSecsSö˚Epoch
()&0xffff;

99 
quöt16
 
‰agmít_cou¡
 = 
zç
.
	`gëRwaD©a
().
	`Àngth
()/
MTU
+1;

100 
quöt16
 
‰agmít_off£t
 = 1;

101 
i
 = 0;ò< 
‰agmít_cou¡
;i++)

103 
Føgmít
 
‰agmít
;

104 
‰agmít
.
idítifõr
 = identifier;

105 
‰agmít
.
‰agmít_cou¡
 = fragment_count;

106 
‰agmít
.
‰agmít_off£t
 = fragment_offset++;

107 
‰agmít
.
d©a
 = 
zç
.
	`gëRwaD©a
().
	`ªmove
(0,
MTU
);

108 
‰agmít
.
Àn
 = føgmít.
d©a
.
	`Àngth
();

109 
‰agmít
.
	`gíî©e
();

110 
£ndLí
 = 
_Sockëli°íî
.
	`wrôeD©agøm
(
‰agmít
.
øwPkg
,
ho°
,
p‹t
);

111 if(
£ndLí
 !
‰agmít
.
øwPkg
.
	`Àngth
())

113 
	`qDebug
("send ZTP dataÉrror: has data %d bytesándáctually send %d bytes!!\n",

114 
zç
.
	`gëRwaD©a
().
	`Àngth
(),
£ndLí
);

115  
FAILED
;

119  
SUCCESS
;

120 
	}
}

123 
¥iv©e
 
	g¶Ÿs
:

124 
⁄Ród
();

	@ztpprotocol.cpp

1 
	~"zç¥Ÿocﬁ.h
"

2 
	~<QByãAºay
>

3 
	~<QDebug
>

4 
	gZTP¥Ÿocﬁ
::
	$ZTP¥Ÿocﬁ
(
QByãAºay
 &
byãs
)

6 
	`lﬂd
(
byãs
);

7 
	}
}

10 
	gZTP¥Ÿocﬁ
::
	$lﬂd
(
QByãAºay
& 
byãs
)

12 
pos
 = 
byãs
.
	`ödexOf
("&head&");

13 
byãs
.
	`ªmove
(
pos
,17);

14 
pos
 = 
byãs
.
	`ödexOf
("&end&");

15 
byãs
.
	`ªmove
(
pos
,5);

16 
QSåögLi°
 
°rLi°
 = 
QSåög
::
	`‰omUtf8
(
byãs
.
	`d©a
(),byãs.
	`Àngth
()).
	`•lô
("&|&");

17 
i
 = 0;i<
°rLi°
.
	`Àngth
();i++)

19 
QSåögLi°
 
subLi°
 = 
°rLi°
[
i
].
	`•lô
(":|:");

20 
QSåög
 
k
 = 
subLi°
[0];

21 
QSåög
 
v
 = 
subLi°
[1];

22 
m≠
.
	`ö£π
(
k
,
v
);

24 
	}
}

25 
	gZTP¥Ÿocﬁ
::
	$˛ór
()

27 
m≠
.
	`˛ór
();

28 
øwD©a
.
	`˛ór
();

29 
	}
}

31 
	gZTP¥Ÿocﬁ
::
	$ªmoveP¨a
(c⁄° 
QSåög
& 
∑øName
)

33 
m≠
.
	`ªmove
(
∑øName
);

34 
	}
}

36 
	gZTP¥Ÿocﬁ
::
	$addP¨a
(c⁄° 
QSåög
& 
∑øName
,c⁄° QSåög& 
∑øVÆue
)

38 
m≠
.
	`ö£π
(
∑øName
,
∑øVÆue
);

39 
	}
}

41 
	gZTP¥Ÿocﬁ
::
	$gí¨©e
()

43 
QLi°
<
QSåög
> 
keyLi°
 = 
m≠
.
	`keys
();

44 
øwD©a
 = "&head&00000000";

45 
i
 = 0;i<
keyLi°
.
	`Àngth
();i++)

47 
øwD©a
.
	`≠≥nd
("&|&");

48 
øwD©a
.
	`≠≥nd
(
keyLi°
[
i
].
	`toUtf8
());

49 
øwD©a
.
	`≠≥nd
(":|:");

50 
øwD©a
.
	`≠≥nd
(
m≠
[
keyLi°
[
i
]].
	`toUtf8
());

52 
øwD©a
.
	`≠≥nd
("&end&");

53 
qöt64
 
Àn
 = 
øwD©a
.
	`Àngth
();

54 
	`mem˝y
(
øwD©a
.
	`d©a
()+6,&
Àn
,8);

55 
	}
}

	@ztpprotocol.h

1 #i‚de‡
ZTPPROTOCOL_H


2 
	#ZTPPROTOCOL_H


	)

3 
	~<QByãAºay
>

4 
	~<QM≠
>

5 
	~<QSåögLi°
>

6 
˛ass
 
	gQSåög
;

7 ˛as†
	cZTP¥Ÿocﬁ


9 
	mQM≠
<
	mQSåög
, QSåög> 
	mm≠
;

10 
QByãAºay
 
	møwD©a
;

11 
	mpublic
:

12 
	$ZTP¥Ÿocﬁ
(){}

13 
ex∂icô
 
	`ZTP¥Ÿocﬁ
(
QByãAºay
& 
byãs
);

14 
QSåög
 
	$gëP¨a
(c⁄° 
QSåög
& 
∑øName
){ 
m≠
[∑øName];
	}
}

15 
addP¨a
(c⁄° 
QSåög
& 
∑øName
,c⁄° QSåög& 
∑øVÆue
);

16 
ªmoveP¨a
(c⁄° 
QSåög
& 
∑øName
);

18 
	$cou¡
()c⁄°{ 
m≠
.
	`cou¡
();
	}
}

19 
	gQLi°
<
	gQSåög
> 
	$∑øs
(){ 
m≠
.
	`keys
();
	}
}

21 
	gpublic
:

22 
gí¨©e
();

23 
	gQByãAºay
& 
	$gëRwaD©a
()c⁄°{ 
øwD©a
;
	}
}

24 
lﬂd
(
QByãAºay
& 
byãs
);

25 
˛ór
();

	@
1
.
1
/usr/include
7
95
main.cpp
mainwindow.cpp
mainwindow.h
ztpmanager.cpp
ztpmanager.h
ztpprotocol.cpp
ztpprotocol.h
